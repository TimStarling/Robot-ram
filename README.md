# DS402 机械臂控制系统

基于CANopen DS402协议的高性能机械臂驱动程序，专为多线程实时控制系统设计。

## 🎯 项目概述

本项目是一个完整的机械臂控制系统上位机软件，采用CANopen DS402协议与机械臂电机通信。系统针对6轴机械臂设计，支持多线程并发处理，确保2ms同步周期的实时性要求。

## 📋 核心特性

### 🚀 高性能架构
- **多线程设计**: 接收线程、发送线程、规划线程三线程协作
- **实时性保证**: 2ms同步周期，满足工业控制实时需求
- **内存优化**: 缓存行对齐数据结构，减少伪共享问题
- **无锁队列**: 使用Boost无锁队列提高并发性能

### 🔧 协议支持
- **CANopen DS402**: 完整支持DS402伺服驱动协议
- **SDO通信**: 安全的服务数据对象通信状态机
- **PDO映射**: 灵活的进程数据对象映射配置
- **多机械臂**: 支持同时控制多条机械臂

### 🛡️ 安全可靠性
- **线程安全**: 原子操作+互斥锁确保数据一致性
- **错误处理**: 完善的超时和错误恢复机制
- **总线安全**: 单事务处理避免总线竞争
- **内存安全**: 智能指针管理生命周期

## 🏗️ 系统架构

### 线程模型

#### 📥 接收线程
- 实时接收CAN帧数据
- 根据帧ID分类处理SDO/PDO
- 更新电机实际状态数据
- 调用数据刷新函数

#### 📤 发送线程  
- 处理SDO请求队列
- 发送PDO数据帧
- 管理发送优先级
- 处理超时和重试

#### 🧮 规划线程
- 计算运动轨迹和规划
- 设置电机目标参数
- 处理外部控制指令
- 协调多轴运动

### 核心数据结构

#### 🎛️ 电机类 (`CLASS_Motor.hpp`)
- 封装DS402对象字典地址
- 管理电机运行状态和参数
- 提供原子化数据访问接口
- 支持PDO数据自动刷新

#### 🔄 SDO状态机 (`SDO_State_Machine.hpp`)
- 线程安全的SDO事务管理
- 支持状态转换和超时检测
- 智能指针生命周期管理
- CANopen标准响应处理

#### 🗂️ PDO配置 (`PDO_config.hpp`)
- 运行时PDO映射表构建
- COB-ID标准化转换
- 多电机批量配置支持
- 编译期+运行时混合配置

#### 📦 CAN帧处理 (`CAN_frame.hpp`)
- 串口转CAN芯片专用格式
- 13字节固定帧结构
- CRC-15校验算法
- 线程安全帧操作接口

## 🖥️ 运行环境

### 目标平台 (Orangepi5)
- **架构**: ARM64 (aarch64)
- **CPU**: 4×Cortex-A55 + 4×Cortex-A76
- **内存**: 16GB DDR4
- **系统**: Linux

### 开发平台
- **架构**: x86_64
- **系统**: Windows 10 / Ubuntu 22.04
- **编译器**: 支持C++17的编译器

## 🛠️ 技术栈

### 编程语言
- **C++17**: 现代C++特性
- **编码标准**: UTF-8中文注释
- **文档**: Doxygen风格

### 第三方库
- **Boost**: 无锁队列和其他工具
- **Pybind11**: Python绑定（可选）
- **标准库**: STL + 并发库

### 构建系统
- **Visual Studio**: Windows平台
- **CMake**: 跨平台构建（计划中）
- **Makefile**: Linux平台

## 📁 项目结构

```
DS402_Robot_Arm_control/
├── CAN_frame.hpp          # CAN帧定义和工具
├── CAN_processing.hpp     # CAN帧解析处理
├── CLASS_Motor.hpp        # 电机核心数据结构
├── Data_processing.hpp    # 数据处理函数
├── PDO_config.hpp         # PDO映射配置
├── SDO_State_Machine.hpp  # SDO状态机
├── Send_Thread.hpp        # 发送线程实现
├── Test_module.hpp        # 功能测试模块
├── main.cpp               # 主程序入口
├── Reference/             # 参考实现
│   ├── CircularBuffer.hpp
│   ├── motor_control.hpp
│   ├── read_frame.hpp
│   ├── send_frame.hpp
│   └── Save_File.hpp
└── x64/                   # 编译输出
    ├── Debug/
    └── Release/
```

## 🚀 快速开始

### 编译项目

#### Windows (Visual Studio)
```bash
# 打开解决方案文件
DS402_Robot_Arm_control.sln
# 选择配置 (Debug/Release)
# 编译运行
```

#### Linux (计划支持)
```bash
# 安装依赖
sudo apt-get install build-essential libboost-all-dev

# 编译
make

# 运行
./DS402_Robot_Arm_control
```

### 基本使用

1. **初始化系统**: 配置串口和CAN参数
2. **加载映射表**: 初始化PDO映射配置
3. **启动线程**: 开启接收、发送、规划线程
4. **控制机械臂**: 通过API发送控制指令
5. **监控状态**: 实时读取电机状态数据

## 🔌 硬件连接

### 串口转CAN芯片
- 使用专用串口转CAN芯片
- 13字节特殊数据帧格式
- 支持标准帧、扩展帧、CAN FD
- 详细协议见 `CAN_frame.hpp`

### 机械臂配置
- **电机数量**: 6个（可扩展）
- **总线速率**: 1Mbps
- **节点ID**: 1-6（每条机械臂）
- **同步周期**: 2ms

## 📊 性能指标

- **同步周期**: 2ms
- **SDO吞吐量**: 10-20帧/配置周期
- **PDO吞吐量**: 主要数据通信
- **线程响应**: 微秒级延迟
- **内存占用**: 优化缓存行对齐

## 🔮 未来规划

### 短期功能
- [ ] CSV动作重现功能
- [ ] 完善的多机械臂支持
- [ ] 增强的错误日志系统
- [ ] Python绑定接口

### 长期功能
- [ ] 运动学算法集成
- [ ] 示教编程功能
- [ ] 高级轨迹规划
- [ ] 可视化监控界面

## 🤝 贡献指南

1. 遵循现有的代码风格和注释规范
2. 使用Doxygen格式编写文档
3. 确保线程安全和内存安全
4. 进行充分的单元测试
5. 优先考虑实时性和性能

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 📞 技术支持

如有技术问题或建议，请通过项目Issue提交。

---

**注意**: 本项目专为工业机械臂控制设计，请确保在使用前充分了解CANopen和DS402协议规范。
